---
命名: __# 4.7 虚拟专用网和网络地址转换
课程:
  - "[[第4章 网络层]]"
状态: 完成
执行人: 蔡蔡鸿宇
时间安排: Invalid date
待解决问题: 待解决:[ 0 ]
created: 2025-05-19T09:22
updated: 2025-05-19T09:23
---
# 4.7 虚拟专用网和网络地址转换

本文档详细探讨计算机网络网络层中的两个重要概念：虚拟专用网（VPN）和网络地址转换（NAT），它们在网络通信，特别是解决IP地址短缺和增强安全性方面发挥着关键作用。我们将根据提供的源文档，构建符合Notion格式的结构化笔记。

## 4.7.1 虚拟专用网VPN

### 4.7.1.1 定义与概念

**虚拟专用网 (VPN)** 是一种利用公共网络（如互联网）构建私有网络的技术。它允许一个机构内部的本地网络与远程分支机构的本地网络通过公共网络安全地连接起来。

VPN的核心在于使用**本地地址 (private address)** 和 **全球地址 (global address)** 的概念。

- **本地地址**：仅在机构内部使用的 IP 地址。这些地址可以由本机构自行分配，不需要向互联网的管理机构申请。
- **全球地址**：在全球范围内唯一的 IP 地址。这些地址必须向互联网的管理机构申请才能使用。

专用地址（本地地址）是不能在互联网上路由的。互联网中的所有路由器对目的地址是专用地址的数据报一律不进行转发。

### 4.7.1.2 RFC 1918 指明的专用地址范围

根据 RFC 1918，以下 IP 地址范围被指定为专用地址：

- **10.0.0.0 到 10.255.255.255**
- **172.16.0.0 到 172.31.255.255**
- **192.168.0.0 到 192.168.255.255**

这些地址只能用于一个机构的内部通信，而不能用于和因特网上的主机通信。它们只能用作本地地址而不能用作全球地址。

### 4.7.1.3 使用隧道技术实现VPN

VPN通常通过**隧道技术 (tunneling)** 实现。当一个机构的内部网络通过公共互联网与其他分支机构或远程用户通信时，源自本地网络的IP数据报（使用本地地址作为源/目的地址）会被封装在另一个IP数据报内部。外部的IP数据报使用全球地址作为源/目的地址，以便能在公共互联网上传输。

考虑部门 A 和部门 B 通过互联网连接，使用隧道技术实现 VPN：

```
graph LR
    subgraph 部门 A (本地地址: 10.1.0.0/16)
        X[主机 X (10.1.0.1)] --> R1[路由器 R1 (125.1.2.3)]
    end

    subgraph 互联网
        R1 -- 隧道 --> R2
    end

    subgraph 部门 B (本地地址: 10.2.0.0/16)
        R2[路由器 R2 (194.4.5.6)] --> Y[主机 Y (10.2.0.3)]
    end

    R1 -- 全球地址 --> R2
```

在这个过程中，从主机 X (10.1.0.1) 发送给主机 Y (10.2.0.3) 的数据报：

1. 在路由器 R1 处，使用本地地址 10.1.0.1 作为源地址，10.2.0.3 作为目的地址的内部 IP 数据报。
2. R1 将这个内部数据报**封装**在一个新的外部 IP 数据报中。
3. 外部数据报的源地址是 R1 的全球地址 (125.1.2.3)，目的地址是 R2 的全球地址 (194.4.5.6)。
4. 这个外部数据报通过互联网传输到 R2。
5. 在路由器 R2 处，剥去外部 IP 首部，取出内部 IP 数据报。
6. 内部数据报的目的地址是 10.2.0.3，R2 将其转发给主机 Y。

这样，尽管通过公共互联网传输，但内部数据报的地址仍然是私有的本地地址，保证了内部网络的连通性和一定程度的隔离性。隧道技术使得通信看起来就像是在一个专用的私有网络中进行。

## 4.7.2 网络地址转换NAT

### 4.7.2.1 定义与目的

**网络地址转换 (NAT)** 是一种解决 IPv4 地址短缺问题的技术。它允许一个机构使用少量的全球 IP 地址，供其内部的大量使用本地地址的主机访问外部网络（如互联网）。

NAT 方法于 1994 年被提出。它要求在专用网连接到因特网的路由器上安装 NAT 软件。装有 NAT 软件的路由器被称为 **NAT 路由器**。NAT 路由器至少需要有一个有效的外部全球地址 (IPG)。

### 4.7.2.2 工作原理

所有使用本地地址的内部主机在和外界通信时，都需要在 NAT 路由器上将其本地地址转换成全球地址 IPG 才能和因特网连接。

网络地址转换过程如下：

1. **内部主机发往外部的数据报**：
    
    - 内部主机 X (本地地址 IPX) 发送数据报到因特网上的主机 Y (全球地址 IPY)。
    - 数据报到达 NAT 路由器。
    - NAT 路由器查找或创建一个 NAT 转换表条目，记录内部地址 (IPX) 和内部端口号与外部地址 (IPG) 和外部端口号的映射关系。
    - NAT 路由器将数据报的**源地址 IPX 转换成其拥有的全球地址 IPG**。
    - 同时，NAT 路由器可能会修改源端口号，以区分不同内部主机的连接。
    - 数据报的目的地址 IPY **保持不变**。
    - 转换后的数据报被发送到因特网。
2. **外部主机发回的数据报**：
    
    - 主机 Y 发回的数据报到达 NAT 路由器。
    - 数据报的源地址是 IPY，目的地址是 IPG (NAT 路由器的全球地址)。
    - NAT 路由器收到目的地址是 IPG 的数据报后，查找其 NAT 转换表。
    - 根据目的地址 IPG 和目的端口号，NAT 路由器找到对应的内部地址 IPX 和内部端口号。
    - NAT 路由器将数据报的**目的地址 IPG 转换为对应的内部地址 IPX**。
    - 同时，如果源端口号被修改过，也会进行相应的还原。
    - 转换后的数据报被转发给最终的内部主机 X。

这个过程使得多个内部主机能够共享同一个（或少量）全球 IP 地址访问外部网络。

### 4.7.2.3 NAT 转换表示例

NAT 路由器维护一个转换表，例如（示意，实际可能更复杂）：

|内部地址 (IPX)|内部端口|外部地址 (IPG)|外部端口|目的地址 (IPY)|目的端口|
|:-:|:-:|:-:|:-:|:-:|:-:|
|192.168.1.2|1234|125.1.2.3|5001|8.8.8.8|80|
|192.168.1.3|5678|125.1.2.3|5002|8.8.8.8|80|

这个表说明内部主机 192.168.1.2 通过本地端口 1234 访问外部地址 8.8.8.8:80 时，NAT 路由器将其源地址/端口转换为 125.1.2.3:5001。当收到发往 125.1.2.3:5001 的数据报时，NAT 路由器知道这是发给 192.168.1.2:1234 的。

使用 NAT 可以有效缓解 IPv4 地址空间的不足，但也引入了一些问题，例如对某些需要端到端连接的应用（如 P2P）支持不好。
